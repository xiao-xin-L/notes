# Linux系统7之系统管理技巧

## 1 监控系统的状态

### 1.1 w指令查看当前系统负载

![image-20200310214623751](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310214623751.png)

该命令显示的信息很丰富。第1行从左至右显示的信息依次为：时间、系统运行时间、登录用户数、平均负载。从第2行开始的所有行则是告诉我们：当前登录的用户名及其登录地址等

最应该关注第1行中的 load average:后面的3个数值。

第1个数值表示1分钟内系统的平均负载值，第2个数值表示5分钟内系统的平均负载值，第3个数值表示15分钟内系统的平均负载值

这个负载指的是对CPU的利用率, 只要数值不大于CPU的数量就行

关于CPU的信息, 我们一般都是存储在/proc/cpuinfo里面

![image-20200310215001764](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310215001764.png)

我们可以看到, 这个CPU的最高频率是2GHZ 缓存是4m, 单核

### 1.2 用vmstat命令监控系统的状态

![image-20200310215550770](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310215550770.png)

命令w查看的是系统整体上的负载，通过看那个数值可以知道当前系统有没有压力。但它无法判断具体是哪里（CPU、内存、磁盘等）有压力，所以这就用到了vmstat。vmstat命令打印的结果共分为6部分：procs、memory、swap、io、system和cpu。

1.  procs显示进程的相关信息。
      	 r（run）：表示运行或等待CPU时间片的进程数。大家不要误认为等待CPU时间片意味着这个进程没有运行，实际上某一时刻1个CPU只能有一个进程占用，其他进程只能排着队等着，此时这些排队等待CPU资源的进程依然是运行状态。该数值如果长期大于服务器CPU的个数，则说明CPU资源不够用了。

   ​	 b（block）：表示等待资源的进程数，这个资源指的是I/O、内存等。举个例子，当磁盘读写非常频繁时，写数据就会非常慢，此时CPU运算很快就结束了，但进程需要把计算的结果写入磁盘，这样进程的任务才算完成，那此时这个进程只能慢慢地等待磁盘了，这样这个进程就是这个b状态。该数值如果长时间大于1，则需要关注一下了

2. memory显示内存的相关信息。

    swpd：表示切换到交换分区中的内存数量，单位为KB。

    free：表示当前空闲的内存数量，单位为KB。

    buff：表示（即将写入磁盘的）缓冲大小，单位为KB。

    cache：表示（从磁盘中读取的）缓存大小，单位为KB。

3. swap显示内存的交换情况。

    si：表示由交换区写入内存的数据量，单位为KB。
    so：表示由内存写入交换区的数据量，单位为KB。

4. io显示磁盘的使用情况

    bi：表示从块设备读取数据的量（读磁盘），单位为KB。
    bo：表示从块设备写入数据的量（写磁盘），单位为KB。

5. system显示采集间隔内发生的中断次数。

    in：表示在某一时间间隔内观测到的每秒设备的中断次数。
    cs：表示每秒产生的上下文切换次数。

6. cpu显示CPU的使用状态。

    us：显示用户下所花费CPU的时间百分比。
    sy：显示系统花费CPU的时间百分比。
    id：表示CPU处于空闲状态的时间百分比。
    wa：表示I/O等待所占用CPU的时间百分比。
    st：表示被偷走的CPU所占百分比（一般都为0，不用关注）。

io部分的bi和bo也是要经常参考的对象，如果磁盘io压力很大，这两列的数值会比较高。另外，当si和so两列的数值比较高并且不断变化时，说明内存不够了，内存中的数据频繁交换到交换分区中，这往往对系统性能影响极大。



### 1.3 top指令显示进程所占的系统资源

![image-20200310220828218](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310220828218.png)

top命令用于动态监控进程所占的系统资源，每隔3秒变一次。它的特点是把占用系统资源（CPU、内存、磁盘I/O等）最高的进程放到最前面。上例中，top命令打印出了很多信息，包括系统负载（loadaverage）、进程数（Tasks）、CPU使用情况、内存使用情况以及交换分区使用情况。这些内容其实可以通过其他命令来查看，用top重点查看的还是下面的进程使用系统资源的详细状况，其中你需要关注%CPU、%MEM和COMMAND这几项所代表的意义。RES这一项为进程所占的内存大小，而%MEM这一项为使用内存的百分比。在top状态下，按Shift+m键可以按照内存使用大小排序。按数字1可以列出所有核CPU的使用状态，按q键可以退出top。

### 1.4 用sar命令监控系统状态

![image-20200310222401105](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310222401105.png)

sar命令很强大，它可以监控系统几乎所有资源的状态，比如平均负载、网卡流量、磁盘状态、内存使用等。与其他系统状态监控工具不同，它可以打印历史信息，可以显示当天从零点开始到当前时刻的系统状态信息

### 1.5 用nload命令查看网卡流量

![image-20200310222608752](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310222608752.png)

最上面一行为网卡名字以及IP地址，按向右箭头可以查看其他网卡的网络流量。输出结果分为两部分，Incoming为进入网卡的流量，Outgoing为网卡出去的流量

### 1.6 用free命令查看内存使用状况

![image-20200310223030037](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310223030037.png)

free命令可以查看当前系统的总内存大小以及使用内存的情况。

​	 total：内存总大小。

​	 used：真正使用的实际内存大小。

​	 free：剩余物理内存大小（没有被分配，纯剩余）。

​	 shared：共享内存大小，不用关注它。

​	 buff/cache：分配给buffer和cache的内存总共有多大。关于buffer和cache大家也许有一些疑惑，因为字面意思上两者很相近。buffer和cache都是一部分内存，内存的作用就是缓解CPU和IO（如，磁盘）的速度差距的，你可以这样理解：数据经过CPU计算，即将要写入磁盘，这时用的内存为buffer；CPU要计算时，需要把数据从磁盘中读出来，临时先放到内存中，这部分内存就是cache。

​	 available：系统可使用内存有多大，它包含了free。Linux系统为了让应用跑得更快，会预先分配一部分内存（buffer/cache）给某些应用使用，虽然这部分内存并没有真正使用，但也已经分配出去了。然而，当另外一个服务要使用更多内存时，是可以把这部分预先分配的内存拿来用的。所以还没有被占用的这部分buffer和cache再加上free就是available。

另外free命令还可以加-m和-g选项（分别以MB或GB为单位）打印内存的使用状况，甚至也支持-h选项

![image-20200310223312448](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310223312448.png)

### 1.7 用ps指令查看系统进程

系统管理员一定要知道你所管理的系统都有哪些进程在运行，在Windows下只要打开任务管理器即可查看

![image-20200310223611655](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310223611655.png)

1. PID：表示进程的ID，这个ID很有用。在Linux中，内核管理进程就得靠pid来识别和管理某一个进程。比如我想终止某一个进程，则用命令“kill 进程的pid”。有时这样并不能终止进程，需要加-9选项，即“kill -9 进程的pid”，但这样有点暴力，严重的时候会丢数据，所以尽量还是别用。

2. STAT：进程的状态。进程状态分为以下几种（不要求记住，但要了解）。
    D：不能中断的进程（通常为IO）。
    R（run）：正在运行中的进程，其中包括了等待CPU时间片的进程。
    S（sleep）：已经中断的进程。通常情况下，系统的大部分进程都是这个状态。
    T：已经停止或者暂停的进程。如果我们正在运行一个命令，比如说sleep 10，我们按一下Ctrl+Z暂停进程时，用ps命令查看就会显示T这个状态。
    W：（内核2.6xx以后不可用），没有足够的内存页分配。
    X：已经死掉的进程（这个好像从来不会出现）。
    Z：僵尸进程，即杀不掉、打不死的垃圾进程，占用系统一点资源，不过没有关系。如果占用太多（一般不会出现），就需要重视了。
    <：高优先级进程。
    N：低优先级进程。
    L：在内存中被锁了内存分页。
    s：主进程
    l：多线程进程。
    +：在前台运行的进程，比如在当前终端执行ps aux就是前台进程。

### 1.8 设置网络配置信息

查看网络配置信息可以用ifconfig指令来实现

![image-20200310230459316](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200310230459316.png)

配置这些基本信息的话, 要在/etc/sysconfig/network-scripts/下的文件里面配置

 ![image-20200311001119309](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200311001119309.png)

## 2 Linux系统的任务计划

其实大部分系统管理工作都是通过定期自动执行某个脚本来完成的，那么如何定期执行某个脚本呢？这就要借助Linux的cron功能了

### 2.1 命令crontab

Linux任务计划功能的操作都是通过crontab命令来完成的，其常用的选项有以下几个。
 -u：表示指定某个用户，不加-u选项则为当前用户。
 -e：表示制定计划任务。
 -l：表示列出计划任务。
 -r：表示删除计划任务。

![image-20200311004856741](Linux%E7%B3%BB%E7%BB%9F7%E4%B9%8B%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%8A%80%E5%B7%A7.assets/image-20200311004856741.png)

```bash
01 10 11 03 3 echo "ok" > /root/cron.log
```

这里每个字段的数字分别表示什么呢？从左到右依次为：分、时、日、月、周和命令行。上例表示在6月5日（这一天必须是星期三）的10点01分执行命令：echo "ok" > /root/cron.log。

如果是定期任务, 那么阔以按照下面的方式来

eg: 

(1) 每天凌晨1点20分清除/var/log/slow.log这个文件

```bash
20 1 * * * echo "" >/var/log/slow.log
```

(2)每天的1点、12点和18点执行/bin/sh  /usr/local/sbin/test.sh

```bash
0 1,12,18 * * * /bin/sh /usr/local/sbin/test.sh
```

(3) 每天的9点到18点执行/bin/sh /usr/local/sbin/test2.sh

```bash
0 9-18 * * * /bin/sh /usr/local/sbin/test2.sh
```

