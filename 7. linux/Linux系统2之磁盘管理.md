# Linux 的磁盘管理

## 1 查看磁盘或是目录的容量

监控磁盘的使用率在日常监控工作中是必须要做的，磁盘被写满是很要命的，严重的情况会导致磁盘损坏。

### 1.1  命令df 

命令df（disk filesystem的简写）用于查看已挂载磁盘的总容量、使用容量、剩余容量等，可以不加任何参数，默认以KB为单位显示。

![image-20200305220244041](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305220244041.png)

/dev、/dev/shm为内存分区，默认大小为内存大小的1/2，如果我们把文件存到这个分区下，相当于存到了内存中，好处是读写非常快，坏处是系统重启时文件就会丢失。后面的/run、/sys/fs/cgroup等分区都是tmpfs，跟/dev/shm类似，为临时
文件系统，我们不要碰它们。df命令的常用选项有 -i、-h、-k和-m

- -i：表示查看inodes的使用状况，如已使用100%，即使磁盘空间有富余，也会提示磁盘空间已满

![image-20200305220604964](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305220604964.png)

- -h：表示使用合适的单位显示，例如G或是M

![image-20200305220758559](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305220758559.png)

- -k、-m：分别表示以KB和MB为单位显示

### 1.2 命令du

命令du（disk useage）用来查看某个目录或文件所占空间的大小，其格式为 du [-abckmsh] [文件或者目录名]。该命令常用的参数有如下几个

1. -a：表示全部文件和目录的大小都列出来。如果后面不加任何选项和参数，则只会列出目录（包含子目录）的大小。如果du命令不指定单位的话，默认显示单位为“KB”

![image-20200305221306454](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305221306454.png)

2. -b：表示列出的值以B为单位输出
3. -k：表示以KB为单位输出，这和默认不加任何选项的输出值是一样的
4. -m：表示以MB为单位输出
5. -h：表示系统自动调节单位。例如，如果文件太小，可能就几千字节，就以KB为单位显示；如果文件大到千兆字节，就以GB为单位显示。

![image-20200305221434201](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305221434201.png)

6. -c：表示最后加总

![image-20200305221646704](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305221646704.png)

7. -s：表示只列出总和

![image-20200305221721558](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%94%A8%E6%88%B7%E4%B8%8E%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86.assets/image-20200305221721558.png)



## 2 磁盘分区和格式化

### 2.1 命令 fdisk

fdisk是Linux下硬盘的分区工具，是一个非常实用的命令，但是fdisk只能划分小于2TB的分区。

该命令的格式为 fdisk [-l ] [设备名称]，其选项只有-l。选项-l后面不加设备名称，会直接列出系统中所有的磁盘设备以及分区表；加上设备名称，则会列出该设备的分区表

![image-20200305225748623](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200305225748623.png)

 

fdisk命令如果不加-l选项，则会进入另一个模式，在该模式下，可以对磁盘进行分区操作。示例命令如下

![image-20200306131927941](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306131927941.png)

![image-20200306131939248](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306131939248.png)

接下来, 我们开始尝试对 /dev/sda2进行分区操作

![image-20200306144139543](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306144139543.png)

使用n命令新建分区，它会提示我们是要e（扩展分区）还是p（主分区）。我们选择p，于是输入p，然后回车，如下所示：

![image-20200306144551885](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306144551885.png)



输入p后，会提示分区数，这里阿铭写1，因为是第1个分区（当然，你也可以写2或3，但最多为4）。如果你直接回车，会继续提示你必须输入一个数字，紧接着又提示你起始扇区从哪里开始，默认是2048，可以写2048或者直接回车（这里你也可以写大于2048的其他数字，不过这样就会造成空间的浪费）。然后提示你输入最后一个扇区的数值，即需要给这个分区划分多大空间。关于扇区是多大，不用再细究，你只需要掌握教给你的方法即可，即写 +1000M，这样既方便又不容易出错。用p命令查看，得知已经多出了一个分区

![image-20200306144811167](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306144811167.png)

删除分区只需要使用d指令就行

![image-20200306211442932](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306211442932.png)

### 2.2 格式化磁盘

磁盘分区虽然分好区了，但暂时还不能用，我们还须对每一个分区进行格式化。所谓格式化，其实就是安装文件系统，Windows下的文件系统有FAT32和NTFS。

命令mke2fs、mkfs.ext2、mkfs.ext3、mkfs.ext4 和mkfs.xfs

mke2fs命令常用的选项如下所示。 

 -b：表示分区时设定每个数据区块占用的空间大小。目前，每个数据块支持1024B、2048B以及4096B。
 -i：表示设定inode的大小。
 -N：表示设定inode的数量。有时默认的inode数不够用，所以要自定义inode的数量。
 -c：表示在格式化前先检测一下磁盘是否有问题。加上这个选项后，运行速度会非常慢。
 -L：表示预设该分区的标签（label）。
 -j：表示建立ext3格式的分区。如果使用mkfs.ext3格式，就不用加这个选项了。
 -t：用来指定文件系统的类型，可以是ext2、ext3 ，也可以是 ext4

![image-20200306211607452](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306211607452.png)

## 3 挂载/卸载磁盘

前面我们讲到了磁盘的分区和格式化，那么格式化完成后，如何使用这些磁盘呢？这就涉及挂载磁盘了。格式化后的磁盘其实是一个块设备文件，类型为b。也许你会想，既然这个块文件就是那个分区，那么直接在那个文件中写数据不就可以写入那个分区了吗？这当然不行。

在挂载某个分区前，需要先建立一个挂载点，这个挂载点是以目录的形式出现的。一旦把某个分区挂载到这个挂载点（目录）下，要再往这个目录写数据时，就都会写到该分区中。所以，在挂载该分区前，挂载点（目录）下必须是个空目录。其实目录不为空并不影响所挂载分区的使用，但一旦挂载上了，该目录下以前的东西就看不到了（数据并没有丢失），除非卸载该分区。



### 3.1 命令 mount

使用这个命令，可以查看当前系统已经挂载的所有分区、分区文件系统的类型、挂载点及一些选项等信息

我们需要先新建一个目录, 然后把新的硬盘挂载目标目录下

![image-20200306212437039](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306212437039.png)



这个时候我们可能没有权限对这个磁盘进行读写操作

![image-20200306213017172](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306213017172.png)

默认下, 只有root用户有该权限

我们可以用 chgrp和chown指令来增加可以使用的用户, 并且修改文件夹权限

![image-20200306213255348](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306213255348.png)



卸载磁盘使用的是**umount**指令

### 3.2 /etc/fstab

![image-20200306215329819](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306215329819.png)

 这个文件中显示了系统启动时需要挂载的各个分区

 第1列就是分区的标识，可以写分区的LABEL、分区的UUID，也可以写分区名（/dev/sda1）。
 第2列是挂载点。
 第3列是分区的格式。
 第4列是mount的一些挂载参数。一般情况下，直接写defaults即可。
 第5列的数字表示是否被dump备份。1表示备份，0表示不备份。
 第6列的数字表示开机时是否自检磁盘。1和2都表示检测，0表示不检测。自检时，1比2优先级高，所以先检测1，再检测2。如果有多个分区需要开机检测，就都设置成2，1检测完后会同时检测2。



接下来我们自行修改该文件, 把我们觉得需要开机就挂载的磁盘,挂载到系统上面

![image-20200306222024286](Linux%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86.assets/image-20200306222024286.png)























